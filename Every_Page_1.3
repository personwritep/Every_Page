// ==UserScript==
// @name         Every Page
// @namespace  http://tampermonkey.net/
// @version       1.3
// @description  ã€Œè¨˜äº‹ã®ç·¨é›†ãƒ»å‰Šé™¤ã€ã®ãƒªã‚¹ãƒˆã§ã€Œå¸¸è¨­ styleã‚¿ã‚°ã€ã‚’è‡ªå‹•è¨˜å…¥ã™ã‚‹
// @author        Ameba Blog User
// @match        https://blog.ameba.jp/ucs/entry/srventrylist*
// @match        https://blog.ameba.jp/ucs/entry/srventryupdate*
// @run-at        document-start
// @grant         none
// ==/UserScript==


window.addEventListener('DOMContentLoaded', function(){ // CSSãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

    let style=
        '<style>'+
        '.include-ex-linkBtn, .save-browserPush, .save-hashtag-module, .adcrossBanner,'+
        '#globalHeader, #ucsHeader, #ucsMainLeft h1, .l-ucs-sidemenu-area, #ucsMainRight, '+
        '#ucsContent::before, #footerAd, #globalFooter, .selection-bar '+
        '{ display: none !important; } '+

        '#ucsContent { width: 930px !important; } '+
        '#ucsMainLeft { width: 930px !important; padding: 0 15px !important; } '+
        '#sorting{ margin: 0 0 4px; } '+
        '#sorting ul { display: none; } '+
        '</style>';

    document.head.insertAdjacentHTML('beforeend', style);

});



window.addEventListener('load', function(){ // ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å­«ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã ã‘ã§åƒã
    let body_id=document.body.getAttribute("id");
    if(body_id=="entryCreate"){ // ã“ã®é …ã ã‘å­«ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã§åƒã

        select_e(close_w);

        function select_e(close_w){
            let error_report=document.querySelector('h1.p-error__head');
            if(error_report==null){
                if(window.opener){
                    report('gray');
                    window.opener.close(); }} // ã‚¨ãƒ©ãƒ¼ç„¡ã„å ´åˆ grayã‚’é€ä¿¡ã€€è¦ªã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹
            else{
                if(window.opener){
                    report('red');
                    window.opener.location.reload();
                }} // ã‚¨ãƒ©ãƒ¼å ±å‘Šã®ã‚ã‚‹å ´åˆã¯ redã‚’é€ä¿¡ã€€è¦ªã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã‚’æ®‹ã™
            close_w(); }

        function close_w(){
            let close_button=document.querySelector('.entryComplete__close');
            close_button.click(); } // å­ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã¯å¸¸ã«é–‰ã˜ã‚‹

        function report(color){
            window.opener.document.querySelector('html').style.color=color; }}});



window.addEventListener('load', function(){ // ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯è¦ªã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã§åƒããƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    let entry_target=document.querySelectorAll('.entry-item .entry');
    let entry_id=document.querySelectorAll('input[name="entry_id"]');
    let publish_f=document.querySelectorAll('input[name="publish_flg"]');
    let list_bar=document.querySelectorAll('#entryList .entry-item');
    let new_win=Array(entry_target.length);
    let link_target=Array(entry_target.length);
    let result_f=Array(entry_target.length);


    let body_id=document.body.getAttribute('id');
    if(body_id=="entryListEdit"){
        let start_button=
            '<p id="start_ep">Start Processing'+
            '<style>'+
            '#sorting { position: relative; } '+
            '#start_ep { position: absolute; top: 4px; right: 15px; font: bold 14px Meiryo; '+
            'width: auto; padding: 1px 15px 0; border: 1px solid #aaa; border-radius: 4px; '+
            'background: #fff; cursor: pointer; }'+
            '</style></p>';

        let sorting=document.querySelector('#sorting');
        if(sorting){
            sorting.insertAdjacentHTML('beforeend', start_button); }

        let start_ep=document.querySelector('#start_ep');
        if(start_ep){
            start_ep.onclick=function(){ start_select(); };

            function start_select(){
                sorting.removeChild(start_ep);
                if(entry_target.length==0 || entry_target==null){ // ç·¨é›†å¯¾è±¡ãŒãƒªã‚¹ãƒˆã«ç„¡ã„å ´åˆ
                    alert('ç·¨é›†å¯¾è±¡ã®è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“'); }
                if(entry_target.length >0){ // ç·¨é›†å¯¾è±¡ãŒãƒªã‚¹ãƒˆã«æœ‰ã‚‹å ´åˆ
                    let ok=confirm('ã“ã®ãƒšãƒ¼ã‚¸ã®å¯¾è±¡è¨˜äº‹ï¼š' + entry_target.length + '\n â¬ã‚¿ã‚°è¨˜å…¥ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ');
                    if(ok){ open_all(); }}}
        }}


    function open_all(){
        open_win(0);
        if(entry_target.length>1){
            let k=1;
            let slow_open=setInterval( function(){
                open_win(k);
                k +=1;
                if(k>=entry_target.length){ clearInterval(slow_open); }}, 4000); }} // 4secã®é–“éš”ã§è‡ªå‹•å®Ÿè¡Œ â­•


    function open_win(k){
        result_f[k]=0;

        link_target[k]='/ucs/entry/srventryupdateinput.do?id='+ entry_id[k].value;
        let top_p=100 + 30*k;
        new_win[k]=window.open(link_target[k], k, 'top=' + top_p + ', left=100, width=600, height=180');

        result_f[k]=1; // èª­è¾¼ã¿é–‹å§‹
        list_bar[k].style.boxShadow='inset 0 0 0 2px #03a9f4'; // ãƒªã‚¹ãƒˆæ¬„ã«é’æ è¡¨ç¤º

        new_win[k].addEventListener('load', function(){
            setTimeout( function(){
                edit_target(publish_f[k].value, k); }, 500); });} // å­ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã§æ›¸è¾¼ã¿é–‹å§‹


    function edit_target(val,k){
        // ä»¥ä¸‹ã® style_textã‚’ç·¨é›†ã™ã‚‹ã¨ã€æ›¸è¾¼ã¾ã‚Œã‚‹ styleã‚¿ã‚°ã®å†…å®¹ã‚’å¤‰æ›´å‡ºæ¥ã¾ã™ ğŸŸ ğŸŸ ğŸŸ 
        let style_text=
            '@import url("https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css");';
        let style_elem='<style class="asa">'+ style_text +'</style>';

        let editor_flg=new_win[k].document.querySelector('input[name="editor_flg"]');

        if(editor_flg.value=='5'){ // æœ€æ–°ç‰ˆã‚¨ãƒ‡ã‚£ã‚¿ã®æ–‡æ›¸ã®å ´åˆ
            let editor_iframe=new_win[k].document.querySelector('.cke_wysiwyg_frame');
            let iframe_doc=editor_iframe.contentWindow.document;
            if(iframe_doc){
                let style_tag=iframe_doc.querySelector('style.asa');
                let iframe_body=iframe_doc.querySelector('body.cke_editable');

                if(style_tag){
                    new_win[k].close();
                    result_f[k]=2; // ç„¡å‡¦ç†
                    list_bar[k].style.boxShadow='none';
                    list_bar[k].style.backgroundColor='#e5f4f3'; } // ã‚¿ã‚°ãŒæœ‰ã‚Œã°å­ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ èƒŒæ™¯ æ·¡ã‚°ãƒªãƒ¼ãƒ³
                else{
                    iframe_body.insertAdjacentHTML('beforeend', style_elem); // styleã‚¿ã‚°æ›¸è¾¼ã¿
                    twice(end_do,k); }}} // æ›¸ãè¾¼ã¿ã—ã¦é€ä¿¡

        if(editor_flg.value=='1'){ // ã‚¿ã‚°ç·¨é›†ã‚¨ãƒ‡ã‚£ã‚¿ã®æ–‡æ›¸ã®å ´åˆ
            let preview=new_win[k].document.querySelector('#js-light-preview');
            let tageditor_text=new_win[k].document.querySelector('#entryTextArea');
            let style_tag=preview.querySelector('style.asa');

            if(style_tag){
                result_f[k]=2; // ç„¡å‡¦ç†
                list_bar[k].style.boxShadow='none';
                list_bar[k].style.backgroundColor='#e5f4f3';
                new_win[k].close(); } // ã‚¿ã‚°ãŒæœ‰ã‚Œã°å­ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ èƒŒæ™¯ æ·¡ã‚°ãƒªãƒ¼ãƒ³
            else{
                tageditor_text.insertAdjacentHTML('beforeend', style_elem); // styleã‚¿ã‚°æ›¸è¾¼ã¿
                twice(end_do,k); }} // æ›¸ãè¾¼ã¿ã—ã¦é€ä¿¡


        function twice(end_do,k){
            setTimeout( function(){
                publish_do(val,k); }, 500);
            end_do(k); }

        function end_do(k){
            result_f[k]=3; // é€ä¿¡å‡¦ç†
            new_win[k].addEventListener('beforeunload', flag_line , false); }

        function flag_line(){
            let send_color=new_win[k].document.querySelector('html').style.color;
            if(send_color=='gray'){
                result_f[k]=4; // æ­£å¸¸çµ‚äº†ã®å ±å‘Š
                list_bar[k].style.boxShadow='none';
                list_bar[k].style.backgroundColor='#bae5ea'; } // å­«ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ãŒç·¨é›†ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ãŸã‚‰ã€€èƒŒæ™¯ã‚°ãƒªãƒ¼ãƒ³
            if(send_color=='red'){
                result_f[k]=5; // ã‚¨ãƒ©ãƒ¼çµ‚äº†ã®å ±å‘Š
                list_bar[k].style.boxShadow='inset 0 0 0 2px red';
                list_bar[k].style.backgroundColor='#ffffff'; }} // å­«ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã®ã‚¨ãƒ©ãƒ¼å ±å‘Šã®å ´åˆã¯é–‰ã˜ãšã€€èƒŒæ™¯ã€€ç™½ èµ¤æ 

        function publish_do(val,k){
            let publish_b0=new_win[k].document.querySelector('button.js-submitButton[publishflg="0"]');
            let publish_b1=new_win[k].document.querySelector('button.js-submitButton[publishflg="1"]');
            if(val==0){ publish_b0.click(); }
            if(val==1){ publish_b1.click(); }
            if(val==2){ publish_b0.click(); }}}

});
